<template>
  <div v-if="isEnabled" class="modal-success">
    <v-dialog v-model="isEnabled" width="500">
      <!-- Activator Slot -->
      <template v-slot:activator="{ on, attrs }">
        <v-btn v-bind="attrs" v-on="on">
          <span>
            ðŸ’£ Open game dialog
          </span>
        </v-btn>
      </template>

      <!-- Default Slot for Dialog Content -->
      <v-card v-show="mode === 'start'">
        <v-card-title style="text-align: center" class="py-6">
          ðŸ’£ Hexagonal Minesweeper Game
        </v-card-title>
        <v-card-text>
          <p>Try to uncover all fields while carefully
          avoiding mines and learn about
          Earth Observation data along the way.
          The amount of uncovered area at the
          end of the game determines your score!
          When the game finishes, a summary of
          significant wildlife species which
          live on the chosen area is shown.
          </p>
          <p>
          Game is played like a standard minesweeper:
          <br>
          Left mouse click to search a hex.
          Right mouse click to flag a mine.</p>
          <p>A random game location is chosen every day.
            To explore new locations, add query parameter
            seed with any value e.g. &seed=SeedString.
            To explore past (or future) locations,
            use seed parameter in JS format Date.toDateString()
            - e.g. "Thu Apr 18 2024".
          </p>
        </v-card-text>

        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn class="green white--text" text @click="start()">Start Game</v-btn>
        </v-card-actions>
      </v-card>

      <v-card v-show="mode === 'gameover'">
        <v-card-title style="text-align: center" class="py-6">Oh no!</v-card-title>
        <v-card-text>
          You stepped on a mine and lost the game. Try again and beat your high score!
          <div class="game-stats">
            <div class="item">
              <span class="name">ðŸŒŸ TOTAL UNCOVERED AREA</span>
              <span class="value">
                {{ Math.round(game.game.getUncoveredAreaPercent() * 100) }}%
              </span>
            </div>

            <div class="item">
              <span class="name">â¬¡ NUMBER OF CELLS</span>
              <span class="value">{{ game.game.fieldCount }}</span>
            </div>

            <div class="item">
              <span class="name">ðŸ’£ NUMBER OF MINES</span>
              <span class="value">{{ game.game.mineCount }}</span>
            </div>

            <v-btn style="font-weight: bold;" ref="copy-btn" color="secondary"
              text @click="copyStatsToClipboard()">Copy to Clipboard</v-btn>
            <h1 class="pa-2" v-if="mode === 'gameover'">Species Info</h1>
            <SpeciesList v-if="mode === 'gameover'" :species="species" :bbox="bbox" />
          </div>
        </v-card-text>

        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn class="primary" text @click="close()">Continue</v-btn>
        </v-card-actions>
      </v-card>

      <v-card v-show="mode === 'win'">
        <v-card-title style="text-align: center" class="py-6">Woo-hoo! ðŸŽ‰</v-card-title>
        <v-card-text>
          Congratulations, you uncovered all fields without stepping on a mine!
          <div class="game-stats">
            <div class="item">
              <span class="name">ðŸŒŸ TOTAL ELAPSED TIME</span>
              <span class="value">{{ elapsedSeconds }}s</span>
            </div>

            <div class="item">
              <span class="name">â¬¡ NUMBER OF CELLS</span>
              <span class="value">{{ game.game.fieldCount }}</span>
            </div>

            <div class="item">
              <span class="name">ðŸ’£ NUMBER OF MINES</span>
              <span class="value">{{ game.game.mineCount }}</span>
            </div>

            <h2 style="margin-top: 24px; margin-bottom: 18px;">Discovered species:</h2>

            <SpeciesList v-if="mode === 'win'" :species="species" :bbox="bbox" />

            <v-btn style="font-weight: bold;" ref="copy-btn" color="secondary"
              text @click="copyStatsToClipboard()">Copy to Clipboard</v-btn>
          </div>
        </v-card-text>

        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn class="primary" text @click="close()">Continue</v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </div>
</template>

<script>
import SpeciesList from '../SpeciesList.vue';

export default {
  components: {
    SpeciesList,
  },
  props: {
    /**
     * The context in which this modal is used. One of 'dashboard' or 'newsletter'.
     * Changing this parameter changes this modal's title and subtitle as well as
     * the arrangement of its inputs.
     */
    mode: {
      type: String,
      default: 'start',
    },
    isEnabled: {
      type: Boolean,
      default: false,
    },
    game: {
      type: Object,
      required: true,
    },
    elapsedSeconds: {
      type: Number,
      required: true,
    },
    bbox: {
      type: Array,
      default: () => [],
    },
    species: {
      type: Array,
      default: () => [],
    },
  },
  methods: {
    close() {
      this.$emit('close');
    },
    start() {
      document.dispatchEvent(new Event('minesweeper:start'));
      this.close();
    },
    copyStatsToClipboard() {
      const date = new Date();

      let string;

      if (this.mode === 'win') {
        string = `âœ¨ #EOxMinesweeper Challenge ${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()}

ðŸŒŸ  TOTAL ELAPSED TIME: ${this.elapsedSeconds} seconds
ðŸ”³  NUMBER OF CELLS:    ${this.game.game.fieldCount}
ðŸ’£  NUMBER OF MINES:    ${this.game.game.mineCount}`;
      } else if (this.mode === 'gameover') {
        string = `âœ¨ #EOxMinesweeper Challenge ${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()}

ðŸŒŸ  TOTAL UNCOVERED AREA: ${Math.round(this.game.game.getUncoveredAreaPercent() * 100)}%
ðŸ”³  NUMBER OF CELLS:      ${this.game.game.fieldCount}
ðŸ’£  NUMBER OF MINES:      ${this.game.game.mineCount}`;
      }

      string += '\n\nDiscovered species:\n';
      string += this.species.reduce((accumulator, s) => `${accumulator}${s.species}${s.common_name === 'Unknown' ? '' : ` - ${s.common_name}`}\n`, '');

      navigator.clipboard.writeText(string);
      this.$refs['copy-btn'].$el.innerText = 'Copied!';
    },
  },
};
</script>

<style lang="scss" scoped>
.eodash-newsletter-banner {
  position: relative;

  .close-button {
    position: absolute;
    right: 18px;
    top: 18px;
    width: 32px;
    height: 32px;
    cursor: pointer;
  }
}

.mobile-modal {
  position: fixed;
  left: 0;
  top: 0;
  right: 0;
  bottom: 0;
}

.game-stats {
  display: flex;
  flex-direction: column;
  align-items: center;

  margin: 20px 0;

  .item {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 16px;

    .name {
      font-weight: 500;
      font-size: 16px;
    }

    .value {
      font-size: 24px;
      margin-top: 8px;
      font-weight: 600;
      //color: #000;
    }
  }
}

.fullwidth {
  left: 0;
  top: 0;
}
</style>
